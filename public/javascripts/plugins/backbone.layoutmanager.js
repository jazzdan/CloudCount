/*!
 * backbone.layoutmanager.js v0.2.1
 * Copyright 2012, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed underthe MIT license.
 */
(function(a,b,c){function d(a){b.each(b.isArray(a)?a:[a],function(a){a.remove(),a.unbind(),a.views&&b.each(a.views,function(a){d(a)}),b.isFunction(a.cleanup)&&a.cleanup.call(a)})}function e(a){function h(b,d){f.cache(c,d),d&&g.html(a.el,g.render(d,b)),e.resolve(a.el)}var c,d,e,g=a._options();return{insert:function(b,c){return c?a.view(b,c,!0):a.view("",b,!0)},render:function(i){var j=a.template||g.template;return a.serialize&&(g.serialize=a.serialize),!i&&b.isFunction(g.serialize)?i=g.serialize.call(a):!i&&b.isObject(g.serialize)&&(i=g.serialize),e=f.makeAsync(g,b.bind(h,a,i)),b.isString(j)&&(c=a._prefix+j),(d=f.cache(c))?(h(i,d,c),e):(b.isString(j)?d=g.fetch.call(e,a._prefix+j):j!=null&&(d=g.fetch.call(e,j)),e._isAsync||h(i,d),e)}}}"use strict";var f=a.View.extend({__manager__:{},constructor:function(c){var d=a.LayoutManager.prototype;c=b.extend({},d.options,c),this._render=function(a){return a(this).render()},this.views={},this.render!==d.render&&(this._render=this.render,this.render=d.render),c.paths&&(this._prefix=c.paths.layout||""),c.views&&this.setViews(c.views),this.template&&(c.template=this.template),a.View.call(this,c)},setViews:function(a){b.each(a,function(a,b){this.view(b,a)},this)},view:function(c,e,g){var h,i,j=this;return this.views[c]&&!g&&d(this.views[c]),e.__manager__={},e instanceof f||(e._render=e.render,e.render===a.View.prototype.render&&(e._render=function(a){return a(this).render()}),e.views&&(e.options.views=e.views),b.extend(e,{views:{},view:f.prototype.view,setViews:f.prototype.setViews,_options:f.prototype._options})),g||(e.__manager__.isManaged=!0),e.render=function(a){function h(){e.__manager__.hasRendered||(i.partial(j.el,c,e.el,g),e.delegateEvents(),e.__manager__.hasRendered=!0),d.resolve(e.el).then(function(d){g||(i.detach(e.el),i.partial(j.el,c,e.el)),b.isFunction(a)&&a(e.el)})}var d=i.deferred();if(!e.__manager__.isManaged)return d.resolve(e.el);try{f.prototype.render.call(e,h)}catch(k){setTimeout(function(){f.prototype.render.call(e,h)},0)}return d.promise()},i=e._options(),!e._prefix&&i.paths&&(e._prefix=i.paths.template||""),i.views&&e.setViews(i.views),g?(h=this.views[c]=this.views[c]||[],h.push(e),e):this.views[c]=e},render:function(a){var c=this,d=this._options(),f=d.deferred();return this._render(e).then(function(){c.__manager__.hasRendered||d.detach(c.el);var a=b.map(c.views,function(a){function e(a,b){if(!a.length)return b();var c=a.shift();c.__manager__.isManaged=!0,c.render(function(){e(a,b)})}var c;return b.isArray(a)?(c=d.deferred(),e(b.clone(a),function(){c.resolve()}),c.promise()):(a.__manager__.isManaged=!0,a.render())});d.when(a).then(function(){f.resolve(c.el)})}),f.then(function(){c.delegateEvents(),b.isFunction(a)&&a(c.el)}).promise()},_options:function(){return b.extend({},f.prototype.options,this.options)}},{_cache:{},cache:function(a,b){if(a in this._cache)return this._cache[a];if(a!=null&&b!=null)return this._cache[a]=b},configure:function(a){b.isObject(a)&&b.extend(f.prototype.options,a)},makeAsync:function(a,b){var c=a.deferred();return c.async=function(){return c._isAsync=!0,b},c}});a.LayoutManager=f,a.LayoutManager.View=a.View,f.prototype.options={paths:{},deferred:function(){return c.Deferred()},fetch:function(a){return b.template(c(a).html())},partial:function(a,b,d,e){var f=b?c(a).find(b):c(a);this[e?"append":"html"](f,d)},html:function(a,b){c(a).html(b)},append:function(a,b){c(a).append(b)},detach:function(a){c(a).detach()},when:function(a){return c.when.apply(null,a)},render:function(a,b){return a(b)}}})(this.Backbone,this._,this.jQuery)